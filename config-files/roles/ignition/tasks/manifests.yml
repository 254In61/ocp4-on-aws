--- 
# - The installation configuration file transforms into the Kubernetes manifests
# - The manifests wrap into the Ignition configuration files.
# - The ignition configuration files are later used to configure the cluster machines.
- name: manifests - Delete any existing manifests created earlier
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ install_dir }}/openshift"
    - "{{ install_dir }}/manifests"

- name: manifests - Generate the K8s manifests for the cluster
  command: "openshift-install create manifests --dir {{ install_dir }}/"

- name: manifests - Create backup dir
  file:
    path: "{{ install_dir }}/backup-manifests"
    state: directory

- name: manifests - Backup the ignition files for future reference
  command: "cp -r {{ item }} {{ install_dir }}/backup-manifests/"
  loop:
    - "{{ install_dir }}/manifests"
    - "{{ install_dir }}/openshift"

# This needs to be worked on!
# - Check that the mastersSchedulable parameter in the $HOME/manifests/cluster-scheduler-02-config.yml.
# - ensure parameter is set to false.This setting prevents pods from being scheduled on the control plane machines.
  
# - name: "manifests - Confirm masterSchedulable==false in {{ install_dir }}/manifests/cluster-scheduler-02-config.yml"
#   command: "yq -p yaml -o json {{ install_dir }}/manifests/cluster-scheduler-02-config.yml | jq -c .spec.mastersSchedulable"
#   register: master_schedulable_output
#   # failed_when: master_schedulable_output["stdout"] != false


# Remove the Kubernetes manifest files that define the control plane machines & control machine set:
# This is to prevent the cluster from automatically generating control plane machines.

# Remove the Kubernetes manifest files that define the control plane machines
# Remove the Kubernetes manifest files that define the control machine set
# Remove the Kubernetes manifest files that define the worker machine set
- name: manifests - Remove the Kubernetes manifest files 
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ install_dir }}/openshift/99_openshift-cluster-api_master-machines-*.yaml"
    - "{{ install_dir }}/openshift/99_openshift-machine-api_master-control-plane-machine-set.yaml"
    - "{{ install_dir }}/openshift/99_openshift-cluster-api_worker-machineset-*.yaml"
