---
# - You must create the bootstrap node in Amazon Web Services (AWS) to use during OpenShift Container Platform cluster initialization. 
# - The provided CloudFormation Template assumes that the Ignition config files for your cluster are served from an S3 bucket. 
# - Create an S3 bucket which will hold the bootstrap.ign ignition file to your cluster.Then upload a copy of the file to the S3 bucket.

# Collect vpc cloudformation stack details
- name: "bootstrap - Collect {{ vpc }} stack info"
  set_fact:
    root_name: "{{ vpc }}"

- import_tasks: ../../../modules/set-vars.yml

# Collect network and load balancers details
- name: "bootstrap - Collect {{ lbs_dns }} stack info"
  set_fact:
    root_name: "{{ lbs_dns }}"

- import_tasks: ../../../modules/set-vars.yml

# Collect sec groups and IAM roles details
- name: "bootstrap - Collect {{ sec_grp }} stack info"
  set_fact:
    root_name: "{{ sec_grp }}"

- import_tasks: ../../../modules/set-vars.yml

- name: bootstrap - Set root name
  set_fact:
    root_name: "{{ bootstrap }}"

- name: bootstrap - Build S3 bucket to store the bootstrap.ign file
  amazon.aws.s3_bucket:
    name: "{{ s3_ignition_file_store }}"
    state: present
  register: s3_create

# - debug:
#     var: s3_create

- name: "bootstrap - Upload bootstrap.ign to s3 bucket"
  community.aws.s3_sync:
    bucket: "{{ s3_ignition_file_store }}"
    file_root: "{{ install_dir }}/bootstrap.ign"

# Confirm if file in the s3 bucket.. Needs some patience and time to get this working.
# - name: create-bootstrap-node - Verify that the file uploaded
#   command: "aws s3 ls s3://{{ s3_ignition_file_store }}"
#   register: s3_files_check
#   failed_when: "'bootstrap.ing' not in s3_files_check.stdout"

- import_tasks: ../../../modules/build-stack.yml
