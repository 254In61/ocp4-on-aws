---
# Re-usable steps to build stack
- name: "build-stack -{{ root_name }}- Setting variables"
  set_fact:
    template_body_file: "{{ cfn_templates_store }}/{{ root_name}}-cfn-template.yaml"
    parameters_file: "{{ install_dir }}/{{ root_name }}-params.json"
    stack_name: "{{ cluster_name }}-{{ root_name }}-stack"

- name: "build-stack -{{ stack_name }}- Build parameters file"
  template:
    src: "{{ root_name }}.json.j2"
    dest: "{{ parameters_file }}"

- name: "build-stack -{{ stack_name }} - Check if {{ stack_name }} exists"
  command: "aws cloudformation describe-stacks --stack-name {{ stack_name }} --region {{ aws_region }}"
  register: stack_exist
  ignore_errors: yes
  
# - debug:
#     var: stack_exist

- debug:
    msg: "{{ stack_name }} exists. Skipping build-stack steps"
  when: stack_exist["failed"]==false

- debug:
    msg: "{{ stack_name }} NOT existing. Proceeding with build-stack steps"
  when: stack_exist["failed"]!=false

- block:
    # Block runs when stack does not exist

    # I faced challenges with getting the template_parameters to source from a .json file..Maybe someone else has time to fix this??
    # - name: "build-stack -{{ root_name }} create a cloudformation stack"
    #   cloudformation:
    #     stack_name: "{{ stack_name }}"
    #     state: "present"
    #     template: "{{ template_body_file }}"
    #     template_parameters:
    #       dist: "{{ lookup('file', '{{ parameters_file }}') }}"

    - name: "build-stack -{{ stack_name }} - create a stack of AWS resources using CloudFormation template"
      command: "aws cloudformation create-stack --stack-name {{ stack_name }} --region {{ aws_region }} --template-body file://{{ template_body_file }} --parameters file://{{ parameters_file }} --capabilities CAPABILITY_NAMED_IAM"
      # when: root_name != "vpc"

    - name: "build-stack -{{ stack_name }} - Sleep for 3 minutes until stack reaches CREATE_COMPLETE status"
      wait_for:
        timeout: 180
      delegate_to: localhost

  when: stack_exist["failed"]!=false

- name: "build-stack -{{ stack_name }} - Get CloudFormation stack facts"
  amazon.aws.cloudformation_info:
    stack_name: "{{ stack_name }}"
  register: stack_info

- debug:
    var: stack_info
